import argparse
import logging
import threading

import pandas as pd

from training_models.classifier_models import DecisionTreeClassifierModel
from training_models.classifier_models import KNeighborsClassifierModel
from training_models.classifier_models import LogisticRegressionClassifierModel
from training_models.classifier_models import NaiveBayesClassifier
from training_models.classifier_models import RandomForestClassifierModel
from training_models.classifier_models import SVMClassifierModel
from training_models.plot_statistics import plot_model_statistics


def main(strategy_name: str, show_plot: bool):
    logging.basicConfig(level=logging.INFO,
                        format='%(asctime)s - %(name)s - %(levelname)s - %(strategy_name)s - %(message)s')
    logger = logging.getLogger(__name__)

    def __log_info(msg):
        logger.info(msg, extra={'strategy_name': strategy_name})

    base_folder_path = f'processed_data/{strategy_name}'
    training_data = pd.read_csv(f'{base_folder_path}/train.csv')
    test_data = pd.read_csv(f'{base_folder_path}/test.csv')

    classifiers = [
        NaiveBayesClassifier,
        DecisionTreeClassifierModel,
        KNeighborsClassifierModel,
        LogisticRegressionClassifierModel,
        RandomForestClassifierModel,
        SVMClassifierModel,
    ]

    __log_info("Training models...")
    classifier_instances = [classifier(training_data, test_data) for classifier in classifiers]
    __train_models(classifier_instances)

    __log_info("Getting and printing statistics...")
    statistics = [model.get_statistics() for model in classifier_instances]
    for stat in statistics:
        __log_info(stat)

    __log_info("Plotting statistics...")
    plot_model_statistics(statistics, strategy_name, show_plot)


def __train_models(classifier_instances):
    threads = [threading.Thread(target=model.train) for model in classifier_instances]
    for thread in threads:
        thread.start()
    for thread in threads:
        thread.join()


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Run data preprocessing with a specified strategy.')
    parser.add_argument('strategy', type=str, help='The name of the preprocessing strategy to use.')
    parser.add_argument('--show-plot', action='store_true', help='Whether to show the plot or not.')
    args = parser.parse_args()
    main(args.strategy, args.show_plot)
