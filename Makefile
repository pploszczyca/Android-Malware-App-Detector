# Define the virtual environment and the python interpreter
VENV := venv
PYTHON := $(VENV)/bin/python
PIP := $(VENV)/bin/pip

# Define your strategies
STRATEGIES := OnePermissionPerFeature GroupPermission

# Default target
all: help

# Target to create and activate the virtual environment, and install requirements
.PHONY: venv
venv:
	@echo "Creating virtual environment..."
	python3 -m venv $(VENV)
	@echo "Activating virtual environment..."
	@source $(VENV)/bin/activate
	@echo "Installing requirements..."
	$(PIP) install -r requirements.txt

# Target to run the data preprocessing script with a specified strategy
.PHONY: run run-data $(addprefix run-data-, $(STRATEGIES))
run: run-data

run-data: $(addprefix run-data-, $(STRATEGIES))

$(addprefix run-data-, $(STRATEGIES)):
	@echo "Running data preprocessing with strategy: $(subst run-data-,,$@)"
	@$(PYTHON) -m data_preprocessing.main $(subst run-data-,,$@)

# Target to run the training script with a specified strategy
.PHONY: run-training $(addprefix run-training-, $(STRATEGIES))

run-training: $(addprefix run-training-, $(STRATEGIES))

$(addprefix run-training-, $(STRATEGIES)):
	@echo "Running training and plotting with strategy: $(subst run-training-,,$@)"
	@$(PYTHON) -m training_models.main $(subst run-training-,,$@)

# Target to run all steps
.PHONY: run-all
run-all:
	@$(MAKE) run-data-OnePermissionPerFeature
	@$(MAKE) run-training-OnePermissionPerFeature
	@$(MAKE) run-data-GroupPermission
	@$(MAKE) run-training-GroupPermission

# Help target to display usage
.PHONY: help
help:
	@echo "Makefile for running data preprocessing and training scripts"
	@echo ""
	@echo "Usage:"
	@echo "  make venv                      - Create and set up the virtual environment"
	@echo "  make run-data-<strategy>       - Run the data preprocessing script with the specified strategy"
	@echo "  make run-training-<strategy>   - Run the training and plotting script with the specified strategy"
	@echo "  make run-all                   - Run data preprocessing and training for all strategies"
	@echo ""
	@echo "Available strategies:"
	@for strat in $(STRATEGIES); do echo "  $$strat"; done

# Clean up (optional)
.PHONY: clean
clean:
	@echo "Cleaning up..."
	@rm -rf __pycache__ $(VENV)
