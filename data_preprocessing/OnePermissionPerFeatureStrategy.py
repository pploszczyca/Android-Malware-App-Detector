import pandas as pd

from data_preprocessing.PreprocessingStrategy import PreprocessingStrategy, Data
from data_preprocessing.data_preprocessor_builder import DataPreprocessorBuilder


class OnePermissionPerFeatureStrategy(PreprocessingStrategy):

    def preprocess(self, data: list[Data]) -> list[pd.DataFrame]:
        columns_to_filter = [
            "Label",
            "ACCESS_COARSE_LOCATION",
            "ACCESS_FINE_LOCATION",
            "ACCESS_WIFI_STATE",
            "CALL_PHONE",
            "CAMERA",
            "CHANGE_WIFI_STATE",
            "GET_ACCOUNTS",
            "GET_TASKS",
            "READ_CONTACTS",
            "READ_EXTERNAL_STORAGE",
            "READ_PHONE_STATE",
            "RECEIVE_BOOT_COMPLETED",
            "RECEIVE_SMS",
            "SEND_SMS",
            "SYSTEM_ALERT_WINDOW",
            "VIBRATE",
            "WAKE_LOCK",
            "WRITE_EXTERNAL_STORAGE",
            "WRITE_SETTINGS",
            "SUM_OF_PERMITTED_PERMISSIONS",
            "INSTALL_SHORTCUT",
            "RECEIVE",
            "READ_LOGS",
            "BILLING",
        ]
        return [self.__process_single_data(d, columns_to_filter) for d in data]

    @staticmethod
    def __process_single_data(d: Data, columns_to_filter: list[str]) -> pd.DataFrame:
        return DataPreprocessorBuilder(data_name=d.data_name, result_col_name=d.result_col_name) \
            .load_data(d.file_path) \
            .remove_columns_containing_arrow() \
            .add_sum_of_permitted_permissions() \
            .normalize_label() \
            .remove_unbalanced_columns(threshold=0.95) \
            .normalize_data() \
            .cut_names_from_all_columns() \
            .filter_columns(columns_to_filter) \
            .show_basic_statistics() \
            .build()
